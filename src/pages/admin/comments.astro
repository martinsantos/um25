---
import Layout from '../../layouts/Layout.astro';
import { loadComments, approveComment, deleteComment } from '../../data/comments';

// Verificación básica de autenticación (deberías implementar algo más seguro)
const isAuthenticated = Astro.cookies.get('adminAuth')?.value === process.env.ADMIN_SECRET;

if (!isAuthenticated) {
    return Astro.redirect('/admin/login');
}

const comments = await loadComments();
const pendingComments = comments.filter(c => !c.isApproved);
---

<Layout title="Administración de Comentarios">
    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Administración de Comentarios</h1>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-6">Comentarios Pendientes de Aprobación</h2>

            <div class="space-y-6">
                {pendingComments.map(comment => (
                    <div class="border-b border-gray-200 pb-6 last:border-0">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-semibold">{comment.author}</h3>
                                <p class="text-sm text-gray-600">{comment.email}</p>
                                <p class="text-sm text-gray-600">
                                    {new Date(comment.createdAt).toLocaleDateString('es-ES', {
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}
                                </p>
                            </div>
                            <div class="flex space-x-4">
                                <button
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                                    data-action="approve"
                                    data-comment-id={comment.id}
                                >
                                    Aprobar
                                </button>
                                <button
                                    class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                                    data-action="delete"
                                    data-comment-id={comment.id}
                                >
                                    Eliminar
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-700">{comment.content}</p>
                        <p class="text-sm text-gray-600 mt-2">Post: {comment.postSlug}</p>
                    </div>
                ))}

                {pendingComments.length === 0 && (
                    <p class="text-gray-600 text-center py-4">No hay comentarios pendientes de aprobación</p>
                )}
            </div>
        </div>
    </main>
</Layout>

<script>
document.addEventListener('click', async (e) => {
    const target = e.target as HTMLElement;
    if (!target.dataset.action || !target.dataset.commentId) return;

    const action = target.dataset.action;
    const commentId = target.dataset.commentId;
    const button = target as HTMLButtonElement;
    
    button.disabled = true;

    try {
        const response = await fetch(`/api/comments/${commentId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) throw new Error(`Error al ${action === 'approve' ? 'aprobar' : 'eliminar'} el comentario`);

        // Eliminar el elemento del DOM
        const commentElement = button.closest('.border-b');
        commentElement?.remove();

        // Verificar si no hay más comentarios
        const commentsContainer = document.querySelector('.space-y-6');
        if (commentsContainer && !commentsContainer.children.length) {
            commentsContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No hay comentarios pendientes de aprobación</p>';
        }
    } catch (error) {
        alert(error.message);
        button.disabled = false;
    }
});
</script>
